<UserControl x:Class="DicomViewer.WpfApp.Views.ViewerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:viewmodels="clr-namespace:DicomViewer.ViewModels;assembly=DicomViewer.ViewModels"
             xmlns:controls="clr-namespace:DicomViewer.UI.Controls;assembly=DicomViewer.UI"
             mc:Ignorable="d"
             Background="{StaticResource BackgroundBrush}"
             d:DataContext="{d:DesignInstance Type=viewmodels:ViewerViewModel}">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="240" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="60" />
        </Grid.ColumnDefinitions>

        <!-- ===== 왼쪽: 시리즈 목록 / Left: Series list ===== -->
        <Border Grid.Column="0" Background="{StaticResource SurfaceBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- 환자 정보 카드 / Patient info card -->
                <Border Grid.Row="0" Background="{StaticResource SurfaceHoverBrush}"
                        CornerRadius="0,0,8,8" Margin="12,0,12,12">
                    <StackPanel Margin="16">
                        <!-- 환자 아이콘 + 이름 / Patient icon + name -->
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="&#xE77B;"
                                       FontFamily="Segoe Fluent Icons, Segoe MDL2 Assets"
                                       FontSize="20"
                                       Foreground="{StaticResource PrimaryBrush}"
                                       VerticalAlignment="Center" />
                            <TextBlock Text="{Binding PatientName}"
                                       Foreground="{StaticResource ForegroundBrush}"
                                       FontWeight="SemiBold"
                                       FontSize="14"
                                       TextTrimming="CharacterEllipsis"
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0" />
                        </StackPanel>
                        <!-- 환자 ID / Patient ID -->
                        <TextBlock Text="{Binding PatientId}"
                                   Foreground="{StaticResource ForegroundSubtleBrush}"
                                   FontSize="12"
                                   Margin="30,6,0,0" />
                        <!-- Study 설명 / Study description -->
                        <TextBlock Text="{Binding StudyDescription}"
                                   Foreground="{StaticResource ForegroundSecondaryBrush}"
                                   FontSize="12"
                                   TextTrimming="CharacterEllipsis"
                                   Margin="30,4,0,0" />
                    </StackPanel>
                </Border>

                <!-- 시리즈 헤더 / Series header -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="16,8,16,8">
                    <TextBlock Text="&#xE8B7;"
                               FontFamily="Segoe Fluent Icons, Segoe MDL2 Assets"
                               FontSize="14"
                               Foreground="{StaticResource ForegroundSubtleBrush}"
                               VerticalAlignment="Center" />
                    <TextBlock Text="SERIES"
                               Foreground="{StaticResource ForegroundSubtleBrush}"
                               FontSize="11"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               Margin="8,0,0,0" />
                </StackPanel>

                <!-- 시리즈 리스트 / Series list -->
                <ListBox Grid.Row="2"
                         ItemsSource="{Binding SeriesList}"
                         SelectedItem="{Binding SelectedSeries}"
                         Style="{StaticResource DarkListBoxStyle}"
                         ItemContainerStyle="{StaticResource DarkListBoxItemStyle}"
                         Margin="8,0,8,8">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <!-- 모달리티 배지 / Modality badge -->
                                <Border Grid.Column="0"
                                        Background="{StaticResource PrimaryBrush}"
                                        CornerRadius="4"
                                        Padding="6,3"
                                        VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Modality}"
                                               Foreground="White"
                                               FontSize="10"
                                               FontWeight="Bold" />
                                </Border>

                                <!-- 시리즈 정보 / Series info -->
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <TextBlock Text="{Binding SeriesDescription}"
                                               Foreground="{StaticResource ForegroundBrush}"
                                               TextTrimming="CharacterEllipsis"
                                               FontSize="12" />
                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                        <TextBlock Text="&#xEB9F;"
                                                   FontFamily="Segoe Fluent Icons, Segoe MDL2 Assets"
                                                   FontSize="10"
                                                   Foreground="{StaticResource ForegroundSubtleBrush}"
                                                   VerticalAlignment="Center" />
                                        <TextBlock Foreground="{StaticResource ForegroundSubtleBrush}"
                                                   FontSize="11"
                                                   Margin="4,0,0,0">
                                            <Run Text="{Binding NumberOfInstances, Mode=OneWay}" />
                                            <Run Text=" images" />
                                        </TextBlock>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>

        <!-- ===== 중앙: DICOM 이미지 뷰어 / Center: DICOM image viewer ===== -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- 이미지 뷰어 / Image viewer -->
            <controls:DicomImageViewer Grid.Row="0"
                                       PatientName="{Binding PatientName}"
                                       WindowWidth="{Binding WindowWidth, Mode=TwoWay}"
                                       WindowCenter="{Binding WindowCenter, Mode=TwoWay}"
                                       ZoomFactor="{Binding ZoomFactor, Mode=TwoWay}"
                                       PanX="{Binding PanX, Mode=TwoWay}"
                                       PanY="{Binding PanY, Mode=TwoWay}"
                                       CurrentSlice="{Binding CurrentSliceIndex, Mode=TwoWay}"
                                       TotalSlices="{Binding TotalSliceCount}"
                                       CurrentTool="{Binding CurrentTool}"
                                       SliceChanged="DicomImageViewer_SliceChanged">
                <controls:DicomImageViewer.ImageSource>
                    <MultiBinding Converter="{StaticResource ByteArrayToBitmapConverter}">
                        <Binding Path="CurrentImagePixels" />
                        <Binding Path="ImageWidth" />
                        <Binding Path="ImageHeight" />
                    </MultiBinding>
                </controls:DicomImageViewer.ImageSource>
            </controls:DicomImageViewer>

            <!-- 로딩 인디케이터 / Loading indicator -->
            <controls:LoadingIndicator IsActive="{Binding IsLoading}"
                                       SpinnerSize="48"
                                       Text="Loading..."
                                       ShowText="True"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center" />

            <!-- 슬라이스 슬라이더 / Slice slider -->
            <Border Grid.Row="1" Background="{StaticResource SurfaceHoverBrush}"
                    CornerRadius="8,8,0,0" Margin="16,0,16,0">
                <Grid Margin="16,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- 현재 슬라이스 / Current slice (1-based for display) -->
                    <Border Grid.Column="0"
                            Background="{StaticResource PrimaryBrush}"
                            CornerRadius="4"
                            Padding="8,4"
                            MinWidth="40">
                        <TextBlock Text="{Binding SliceDisplayNumber}"
                                   Foreground="White"
                                   FontWeight="SemiBold"
                                   HorizontalAlignment="Center" />
                    </Border>

                    <!-- 슬라이더 / Slider -->
                    <controls:ModernSlider Grid.Column="1"
                                           Minimum="0"
                                           Maximum="{Binding MaxSliceIndex}"
                                           Value="{Binding CurrentSliceIndex}"
                                           VerticalAlignment="Center"
                                           Margin="16,0" />

                    <!-- 총 슬라이스 / Total slices -->
                    <Border Grid.Column="2"
                            Background="{StaticResource SurfaceBrush}"
                            CornerRadius="4"
                            Padding="8,4"
                            MinWidth="40">
                        <TextBlock Text="{Binding TotalSliceCount}"
                                   Foreground="{StaticResource ForegroundSecondaryBrush}"
                                   HorizontalAlignment="Center" />
                    </Border>
                </Grid>
            </Border>
        </Grid>

        <!-- ===== 오른쪽: 도구 패널 / Right: Tools panel ===== -->
        <Border Grid.Column="2" Background="{StaticResource SurfaceHoverBrush}">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="8,12">
                    <!-- 도구 섹션 / Tools section -->
                    <TextBlock Text="TOOLS"
                               Foreground="{StaticResource ForegroundSubtleBrush}"
                               FontSize="9"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,8" />

                    <!-- Pan 도구 / Pan tool -->
                    <controls:IconToggleButton
                        Icon="&#xE8B0;"
                        Text="Pan"
                        ShowText="True"
                        IconSize="18"
                        IsChecked="{Binding CurrentTool, Converter={StaticResource ToolEnumConverter}, ConverterParameter=Pan}"
                        Command="{Binding SelectToolCommand}"
                        CommandParameter="{x:Static viewmodels:ViewerTool.Pan}"
                        ToolTip="Pan - Drag to move image"
                        Margin="0,2" />

                    <!-- Zoom 도구 / Zoom tool -->
                    <controls:IconToggleButton
                        Icon="&#xE71E;"
                        Text="Zoom"
                        ShowText="True"
                        IconSize="18"
                        IsChecked="{Binding CurrentTool, Converter={StaticResource ToolEnumConverter}, ConverterParameter=Zoom}"
                        Command="{Binding SelectToolCommand}"
                        CommandParameter="{x:Static viewmodels:ViewerTool.Zoom}"
                        ToolTip="Zoom - Drag up/down to zoom"
                        Margin="0,2" />

                    <!-- Window/Level 도구 / Window/Level tool -->
                    <controls:IconToggleButton
                        Icon="&#xE793;"
                        Text="W/L"
                        ShowText="True"
                        IconSize="18"
                        IsChecked="{Binding CurrentTool, Converter={StaticResource ToolEnumConverter}, ConverterParameter=WindowLevel}"
                        Command="{Binding SelectToolCommand}"
                        CommandParameter="{x:Static viewmodels:ViewerTool.WindowLevel}"
                        ToolTip="Window/Level - Adjust brightness/contrast"
                        Margin="0,2" />

                    <Separator Background="{StaticResource BorderSubtleBrush}"
                               Margin="4,12" />

                    <!-- 액션 버튼 / Action buttons -->
                    <TextBlock Text="ACTIONS"
                               Foreground="{StaticResource ForegroundSubtleBrush}"
                               FontSize="9"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,8" />

                    <!-- 리셋 / Reset -->
                    <controls:IconButton
                        Icon="&#xE72C;"
                        Text="Reset"
                        ShowText="True"
                        IconSize="16"
                        Command="{Binding ResetViewCommand}"
                        ToolTip="Reset all transformations"
                        Margin="0,2" />

                    <!-- Zoom In -->
                    <controls:IconButton
                        Icon="&#xE8A3;"
                        IconSize="16"
                        Command="{Binding ZoomInCommand}"
                        ToolTip="Zoom In"
                        Margin="0,2" />

                    <!-- Zoom Out -->
                    <controls:IconButton
                        Icon="&#xE71F;"
                        IconSize="16"
                        Command="{Binding ZoomOutCommand}"
                        ToolTip="Zoom Out"
                        Margin="0,2" />

                    <Separator Background="{StaticResource BorderSubtleBrush}"
                               Margin="4,12" />

                    <!-- W/L 프리셋 / W/L Presets -->
                    <TextBlock Text="PRESETS"
                               Foreground="{StaticResource ForegroundSubtleBrush}"
                               FontSize="9"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,8" />

                    <!-- CT Abdomen -->
                    <controls:IconButton
                        Icon="&#xEBD2;"
                        Text="Abd"
                        ShowText="True"
                        IconSize="14"
                        Command="{Binding ApplyWindowLevelPresetCommand}"
                        CommandParameter="Abdomen"
                        ToolTip="CT Abdomen (W:400 L:40)"
                        Margin="0,2" />

                    <!-- CT Lung -->
                    <controls:IconButton
                        Icon="&#xE95E;"
                        Text="Lung"
                        ShowText="True"
                        IconSize="14"
                        Command="{Binding ApplyWindowLevelPresetCommand}"
                        CommandParameter="Lung"
                        ToolTip="CT Lung (W:1500 L:-600)"
                        Margin="0,2" />

                    <!-- CT Bone -->
                    <controls:IconButton
                        Icon="&#xE9D9;"
                        Text="Bone"
                        ShowText="True"
                        IconSize="14"
                        Command="{Binding ApplyWindowLevelPresetCommand}"
                        CommandParameter="Bone"
                        ToolTip="CT Bone (W:2000 L:400)"
                        Margin="0,2" />

                    <!-- CT Brain -->
                    <controls:IconButton
                        Icon="&#xE94E;"
                        Text="Brain"
                        ShowText="True"
                        IconSize="14"
                        Command="{Binding ApplyWindowLevelPresetCommand}"
                        CommandParameter="Brain"
                        ToolTip="CT Brain (W:80 L:40)"
                        Margin="0,2" />
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</UserControl>
